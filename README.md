## Welcome to i3ass-dev

There are two main branches of this repository,
with two different purposes.
This branch, **dev**, 
is meant to serve as a base for setting up a development environment for i3ass. 

The **ass** directory contains submodules pointing to the other repositories in the **i3ass-dev** organization. 
When the development environment is setup, 
one can add the **lnk** directory to the **$PATH** environment variable.  

Use the **setup.sh** script included in this repository to automatically initialize the development environment,
which consist of two steps:  

1. initialize and update the submodules, this will populate the **ass** directory with the submodules.
2. Execute `bashbud --bump` in each submodule, which in turn will generate a bunch of files that are vital to the scripts.

### what is bashbud

[bashbud](https://github.com/budlabs/bashbud) is a scaffolding program developed by budlabs that is used extensively in the **i3ass** project.
If you take a look at the content for one of the other repositories in this,
[i3ass-dev](https://github.com/i3ass-dev), organization.
The file structure will look something like this:  

```
bashbud/
lib/
main.sh
manifest.d/
manifest.md
README.md
```

**main.sh** is the script which the symbolic links in **lnk/** points to. 

``` shell
$ ls -l lnk/i3gw
lnk/i3gw -> ../ass/i3gw/main.sh
```

If one would just clone one of the repositories and not executing `bashbud --bump`,
**main.sh** would **NOT** work. The structure of a `main.sh` looks something like this:  

``` bash
#!/bin/bash

main(){
  :
}

___source="$(readlink -f "${BASH_SOURCE[0]}")"  #bashbud
___dir="${___source%/*}"                        #bashbud
source "$___dir/init.sh"                        #bashbud
main "$@"                                       #bashbud
```

as you can see it tries to source a file called **init.sh**, which is not included in the repository, but this is one of the files that will get automatically generated by **bashbud**.

After being generated, **init.sh** could look like this:  
``` bash
#!/bin/bash

___printversion(){
  
cat << 'EOB' >&2
i3get - version: 0.632
updated: 2020-08-12 by budRich
EOB
}

# environment variables
: "${I3FYRA_MAIN_CONTAINER:=A}"
: "${I3FYRA_WS:=}"
: "${I3FYRA_ORIENTATION:=horizontal}"

___printhelp(){
  
cat << 'EOB' >&2
i3get - prints info about a specific window to stdout


SYNOPSIS
--------
i3get [--class|-c CLASS]     
i3get --help|-h
i3get --version|-v

OPTIONS
-------

--class|-c CLASS  
Search for windows with the given class

--help|-h  
Show help and exit.

--version|-v  
Show version and exit
...
EOB
}

for ___f in "${___dir}/lib"/*; do
  source "$___f"
done

declare -A __o
options="$(
  getopt --name "[ERROR]:i3get" \
    --options "c:hv" \
    --longoptions "class:,help,version," \
    -- "$@" || exit 77
)"

eval set -- "$options"
unset options

while true; do
  case "$1" in
    --class      | -c ) __o[class]="${2:-}" ; shift ;;
    --help       | -h ) ___printhelp && exit ;;
    --version    | -v ) ___printversion && exit ;;
    -- ) shift ; break ;;
    *  ) break ;;
  esac
  shift
done

[[ ${__lastarg:="${!#:-}"} =~ ^--$|${0}$ ]] \
  && __lastarg="" 
```

As you can see **init.sh** includes two functions (`___printversion()` and `___printhelp()`), which in turn are called further down when the commandline options are parsed with `getopt` if `--help|-h` or `--version|-v` are used, other command line options value or argument are stored in the global array `declare -A __o`, (f.i. `__o[class]`). Environment variables are also declared in this file, and all files in the **lib/** directory are sourced.  

### the manifest

Before **bashbud** generates the **init.sh** file it parses the *manifest*, which is the content (if any) in the **manifest.d/** directory concatenated to the **manifest.md** file (which is mandatory). The manifest consist of two parts:  

1. A [YAML](https://en.wikipedia.org/wiki/YAML) frontmatter (mandatory)
2. A **Markdown** *body* (optional)

The **manifest** for our example **init.sh** above would look something like this:  

```
---
description: >
  prints info about a specific window to stdout
updated:       2020-08-12
version:       0.632
author:        budRich
repo:          https://github.com/budlabs/i3ass
created:       2017-03-08
dependencies:  [bash, i3]
see-also:      [bash(1), i3(1)]
environ:
    I3FYRA_MAIN_CONTAINER:  A
    I3FYRA_WS:
    I3FYRA_ORIENTATION: horizontal
synopsis: |
    [--class|-c CLASS]      
    --help|-h
    --version|-v
...

# options-help-description
Show help and exit.

# options-version-description
Show version and exit

# options-class-description
Search for windows with the given class
```

The reason to use **bashbud** is that we now only need to to edit one source (the manifest) when we want to add new commandline options and add documentation. Because bashbud does also generate f.i. the manpage, and wikipage. Another very important file generated is **program.sh**, which is a the concatenation of **main.sh**, **init.sh** and the files inside the **lib/** directory. Meaning a fully functional standalone script without any `source` commands. It is this file, **program.sh**, that is copied to the [github.com/budlabs/i3ass/src](https://github.com/budlabs/i3ass/src) directory before release and which is then installed as the actual command.  

So I guess, that is the other reason we use **bashbud**, 
we can have two different versions (published and development) of the script, 
while still being certain that they have the same content.

When developing it is only necessary to execute `bashbud --bump` if the manifest changes (or if files inside **conf/** or **awklib/** directories are changed...) .
But most of the time one will just edit the **main.sh** file or the files in the **lib/** directory,
which should contain functions related to the script, one function/file.  

### ShellCheck

[ShellCheck](https://www.shellcheck.net/) is used to lint the code,
but it is only used on **program.sh**,
since it gets weired linting bash scripts scattered across multiple files.
A **watch.sh** script should be included in most of the repositories,
and it uses `inotifywait` to listen for changes on the files that aren't autogenerated and will automatically perform `bashbud --bump` and a shellcheck test on the generated `program.sh`, so it is recommended to have **watch.sh** running in a terminal while developing. This stuff will get expanded with more elaborate testing in the future.  

### release

The other branch of the repository, [release](https://github.com/i3ass-dev/i3ass/tree/release) have it's own bashbud templates, that will create a new release of **i3ass** and it should only be used for that purpose by the maintainer (budRich).  

### pull requests

Pull requests should be done towards a repositories **next** branch.
If they are accepted they get merged into the repositories **master** branch,
the version of the command will get incremented and the **master** branch will get tagged with the same version. Do not, make pull requests to repositories named **i3ass** (this one and the one at: [budlabs/i3ass](https://github.com/budlabs/i3ass)).
